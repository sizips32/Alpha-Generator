import streamlit as st
import pandas as pd
import numpy as np
import requests

# --- ë°ì´í„° ì‹œë®¬ë ˆì´ì…˜ í•¨ìˆ˜ ---
@st.cache_data
def simulate_financial_data(num_stocks=50, num_days=252):
    dates = pd.bdate_range(start='2023-01-01', periods=num_days)
    stocks = [f'STOCK_{i:03d}' for i in range(num_stocks)]
    data = []
    for stock in stocks:
        prices = np.cumprod(1 + np.random.normal(0.0005, 0.01, num_days)) * 100
        volumes = np.random.randint(100_000, 10_000_000, num_days)
        pbr = np.random.uniform(0.5, 5.0, num_days)
        roe = np.random.uniform(0.01, 0.30, num_days)
        df = pd.DataFrame({
            'Date': dates,
            'Stock': stock,
            'Close': prices,
            'Open': prices * (1 + np.random.normal(0, 0.005, num_days)),
            'High': prices * (1 + np.random.uniform(0, 0.01, num_days)),
            'Low': prices * (1 - np.random.uniform(0, 0.01, num_days)),
            'Volume': volumes,
            'PBR': pbr,
            'ROE': roe,
            'Future_Return': np.random.normal(0.001, 0.02, num_days)
        })
        data.append(df)
    combined_df = pd.concat(data).set_index('Date')
    return combined_df

financial_data = simulate_financial_data()

# --- Gemini API ì—°ë™ í•¨ìˆ˜ ê°œì„  ---
def gemini_generate_features(user_idea, api_key):
    prompt = f"""
    ì•„ë˜ëŠ” íˆ¬ì ì „ëµ ì•„ì´ë””ì–´ì…ë‹ˆë‹¤.
    1. ì´ ì•„ì´ë””ì–´ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ê¸ˆìœµ í”¼ì²˜(ì˜ˆ: PBR, ROE, Momentum, ê±°ë˜ëŸ‰ ë“±)ë¥¼ ìµœëŒ€í•œ ë§ì´ ì¶”ì²œí•´ ì£¼ì„¸ìš”.
    2. ê° í”¼ì²˜ë¥¼ ì¡°í•©í•œ ìˆ˜ì‹(íŒŒì´ì¬ pandas ì½”ë“œ í˜•íƒœ)ë„ 2~3ê°œ ì œì•ˆí•´ ì£¼ì„¸ìš”.
    3. ë¨¸ì‹ ëŸ¬ë‹/ë”¥ëŸ¬ë‹(ì˜ˆ: ëœë¤í¬ë ˆìŠ¤íŠ¸, MLP, XGBoost, PCA, AutoEncoder ë“±)ìœ¼ë¡œ íŒ©í„°ë¥¼ ìƒì„±í•˜ëŠ” ë°©ë²•ë„ 2~3ê°œ ì œì•ˆí•´ ì£¼ì„¸ìš”(ì˜ˆ: 'RandomForestë¡œ ì¤‘ìš” í”¼ì²˜ ì¡°í•©', 'MLP ì„ë² ë”©', 'PCA ì£¼ì„±ë¶„', 'XGBoost ì¤‘ìš”ë„').
    4. ê²°ê³¼ëŠ” ì•„ë˜ ì˜ˆì‹œì²˜ëŸ¼ JSONìœ¼ë¡œ ë°˜í™˜í•´ ì£¼ì„¸ìš”.

    ì˜ˆì‹œ:
    {{
      "features": ["PBR", "ROE", "Momentum", "Volume"],
      "formulas": [
        "ROE / PBR",
        "Close.pct_change(20) * Volume"
      ],
      "ml_factors": [
        "RandomForestRegressorë¡œ í”¼ì²˜ ì¤‘ìš”ë„ ê¸°ë°˜ ì¡°í•©",
        "MLPRegressorë¡œ ì ì¬ íŒ©í„°(ì„ë² ë”©) ì¶”ì¶œ",
        "XGBoostë¡œ ì¤‘ìš”ë„ ê¸°ë°˜ ì¡°í•©",
        "PCAë¡œ ì£¼ì„±ë¶„ íŒ©í„° ìƒì„±"
      ]
    }}

    ì•„ì´ë””ì–´: {user_idea}
    """
    # ìµœì‹  ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
    url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent"
    headers = {"Content-Type": "application/json"}
    data = {
        "contents": [{"parts": [{"text": prompt}]}],
        "generationConfig": {"temperature": 0.7, "maxOutputTokens": 512}
    }
    params = {"key": api_key}
    try:
        response = requests.post(url, headers=headers, params=params, json=data)
        response.raise_for_status()
        text = response.json()['candidates'][0]['content']['parts'][0]['text']
        import json
        text = text.strip()
        # ì½”ë“œë¸”ë¡ ì œê±° (ë” ê²¬ê³ í•˜ê²Œ)
        if text.startswith("```json"):
            text = text[7:]
        if text.endswith("```"):
            text = text[:-3]
        # JSON íŒŒì‹±
        try:
            return json.loads(text)
        except Exception as e:
            raise ValueError(f"Gemini ì‘ë‹µì„ JSONìœ¼ë¡œ íŒŒì‹±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤: {e}\nì‘ë‹µ ë‚´ìš©: {text}")
    except Exception as e:
        raise RuntimeError(f"Gemini API í˜¸ì¶œ ì˜¤ë¥˜: {e}")

# --- UI ---
st.title("ì‹œì¥ ì•„ì´ë””ì–´ ê¸°ë°˜ AI íŒ©í„° ìƒì„±ê¸°")

api_key = st.text_input("Gemini API Keyë¥¼ ì…ë ¥í•˜ì„¸ìš”", type="password")
st.markdown("**ì‹œì¥ ì•„ì´ë””ì–´ë¥¼ ì§ì ‘ ì…ë ¥í•˜ê±°ë‚˜ .md íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”.**")
col1, col2 = st.columns(2)
with col1:
    user_idea = st.text_area("ì‹œì¥ ì•„ì´ë””ì–´ ì…ë ¥", height=150)
with col2:
    uploaded_file = st.file_uploader(".md íŒŒì¼ ì—…ë¡œë“œ", type=["md"])
    if uploaded_file:
        user_idea = uploaded_file.read().decode("utf-8")

if st.button("AIë¡œ í”¼ì²˜/ìˆ˜ì‹/MLíŒ©í„° ì¶”ì²œë°›ê¸°") and api_key and user_idea:
    with st.spinner("Gemini AIê°€ ì•„ì´ë””ì–´ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..."):
        try:
            result = gemini_generate_features(user_idea, api_key)
            st.session_state['ai_result'] = result
            st.success("ì¶”ì²œ ê²°ê³¼:")
            st.write("**ì¶”ì²œ í”¼ì²˜:**", ", ".join(result.get("features", [])))
            st.write("**ì¶”ì²œ ìˆ˜ì‹:**")
            for formula in result.get("formulas", []):
                st.code(formula, language="python")
            st.write("**ML/DL ê¸°ë°˜ íŒ©í„° ìƒì„±ë²•:**")
            for ml_factor in result.get("ml_factors", []):
                st.write("- " + ml_factor)
        except Exception as e:
            st.error(f"Gemini API ì˜¤ë¥˜: {e}")

# --- íŒ©í„° ìƒì„± UI ---
result = st.session_state.get('ai_result', None)
if result:
    st.markdown("---")
    st.subheader("ì¶”ì²œ ìˆ˜ì‹/MLíŒ©í„° ì¤‘ íŒ©í„°ë¡œ ìƒì„±")
    tab1, tab2 = st.tabs(["ìˆ˜ì‹ ê¸°ë°˜", "ML/DL ê¸°ë°˜"])
    with tab1:
        selected_formula = st.selectbox("ìˆ˜ì‹ ì„ íƒ", result.get("formulas", []))
        if st.button("ì´ ìˆ˜ì‹ìœ¼ë¡œ íŒ©í„° ìƒì„±"):
            try:
                # í—ˆìš©ëœ ì»¬ëŸ¼ë§Œ í¬í•¨ëëŠ”ì§€ ì²´í¬
                allowed_cols = set(financial_data.columns)
                import re
                tokens = re.findall(r"[A-Za-z_][A-Za-z0-9_]*", selected_formula)
                for token in tokens:
                    if token not in allowed_cols and not token.isnumeric():
                        st.error(f"í—ˆìš©ë˜ì§€ ì•Šì€ ì»¬ëŸ¼/ë³€ìˆ˜: {token}")
                        st.stop()
                # eval ì‹¤í–‰
                try:
                    factor_series = financial_data.eval(selected_formula)
                except Exception as e:
                    st.error(f"ìˆ˜ì‹ ì‹¤í–‰ ì˜¤ë¥˜: {e}")
                    st.stop()
                # ê°’ ê²€ì¦
                if factor_series.isnull().all():
                    st.error("ìˆ˜ì‹ ê²°ê³¼ê°€ ëª¨ë‘ NaNì…ë‹ˆë‹¤. ìˆ˜ì‹ì„ í™•ì¸í•˜ì„¸ìš”.")
                    st.stop()
                if np.abs(factor_series).max() > 1e6:
                    st.warning("ìˆ˜ì‹ ê²°ê³¼ê°’ì´ ë¹„ì •ìƒì ìœ¼ë¡œ í½ë‹ˆë‹¤. ìˆ˜ì‹ì„ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”.")
                factor_name = f"AI_{selected_formula.replace(' ', '').replace('*','x').replace('/','_div_')}"
                multi_index_df = financial_data.reset_index().set_index(['Date', 'Stock'])
                factor_series = pd.Series(factor_series.values, index=multi_index_df.index, name=factor_name)
                factor_series = factor_series.fillna(method='ffill').fillna(method='bfill')
                simulated_ic = np.random.uniform(0.01, 0.10)
                simulated_icir = simulated_ic / np.random.uniform(0.01, 0.05)
                if 'factor_zoo' not in st.session_state:
                    st.session_state.factor_zoo = {}
                st.session_state.factor_zoo[factor_name] = {
                    'data': factor_series,
                    'ic': simulated_ic,
                    'icir': simulated_icir,
                    'expression': selected_formula
                }
                st.success(f"íŒ©í„° '{factor_name}' ìƒì„± ì™„ë£Œ!")
            except Exception as e:
                st.error(f"íŒ©í„° ìƒì„± ì˜¤ë¥˜: {e}")
    with tab2:
        selected_ml = st.selectbox("ML/DL íŒ©í„° ìƒì„±ë²• ì„ íƒ", result.get("ml_factors", []))
        if st.button("ì´ ML/DL ë°©ë²•ìœ¼ë¡œ íŒ©í„° ìƒì„±"):
            try:
                # ì…ë ¥ í”¼ì²˜ ì²´í¬
                required_cols = ['Close', 'Volume', 'PBR', 'ROE']
                for col in required_cols:
                    if col not in financial_data.columns:
                        st.error(f"ë°ì´í„°ì— '{col}' ì»¬ëŸ¼ì´ ì—†ìŠµë‹ˆë‹¤.")
                        st.stop()
                # ë¼ì´ë¸ŒëŸ¬ë¦¬ import ì²´í¬
                try:
                    if "RandomForest" in selected_ml:
                        from sklearn.ensemble import RandomForestRegressor
                    elif "MLP" in selected_ml:
                        from sklearn.neural_network import MLPRegressor
                    elif "XGBoost" in selected_ml:
                        from xgboost import XGBRegressor
                    elif "PCA" in selected_ml:
                        from sklearn.decomposition import PCA
                    elif "AutoEncoder" in selected_ml:
                        from sklearn.preprocessing import StandardScaler
                        from tensorflow.keras.models import Model
                        from tensorflow.keras.layers import Input, Dense
                except ImportError as e:
                    st.error(f"í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤: {e}")
                    st.stop()
                # ëª¨ë¸ í•™ìŠµ ë° íŒ©í„° ìƒì„±
                if "RandomForest" in selected_ml:
                    X = financial_data[['Close', 'Volume', 'PBR', 'ROE']].fillna(0)
                    y = financial_data['Future_Return'].fillna(0)
                    model = RandomForestRegressor(n_estimators=100, random_state=42)
                    model.fit(X, y)
                    importances = model.feature_importances_
                    factor_series = pd.Series(np.dot(X, importances), index=X.index)
                    factor_name = "RF_ì¤‘ìš”ë„_ì¡°í•©"
                elif "MLP" in selected_ml:
                    X = financial_data[['Close', 'Volume', 'PBR', 'ROE']].fillna(0)
                    y = financial_data['Future_Return'].fillna(0)
                    model = MLPRegressor(hidden_layer_sizes=(64, 32), max_iter=200, random_state=42)
                    model.fit(X, y)
                    factor_series = pd.Series(model.predict(X), index=X.index)
                    factor_name = "MLP_ì„ë² ë”©"
                elif "XGBoost" in selected_ml:
                    X = financial_data[['Close', 'Volume', 'PBR', 'ROE']].fillna(0)
                    y = financial_data['Future_Return'].fillna(0)
                    model = XGBRegressor(n_estimators=100, random_state=42)
                    model.fit(X, y)
                    importances = model.feature_importances_
                    factor_series = pd.Series(np.dot(X, importances), index=X.index)
                    factor_name = "XGB_ì¤‘ìš”ë„_ì¡°í•©"
                elif "PCA" in selected_ml:
                    X = financial_data[['Close', 'Volume', 'PBR', 'ROE']].fillna(0)
                    pca = PCA(n_components=1)
                    factor_series = pd.Series(pca.fit_transform(X).flatten(), index=X.index)
                    factor_name = "PCA_ì£¼ì„±ë¶„"
                elif "AutoEncoder" in selected_ml:
                    X = financial_data[['Close', 'Volume', 'PBR', 'ROE']].fillna(0)
                    scaler = StandardScaler()
                    X_scaled = scaler.fit_transform(X)
                    input_dim = X_scaled.shape[1]
                    input_layer = Input(shape=(input_dim,))
                    encoded = Dense(2, activation='relu')(input_layer)
                    decoded = Dense(input_dim, activation='linear')(encoded)
                    autoencoder = Model(input_layer, decoded)
                    autoencoder.compile(optimizer='adam', loss='mse')
                    autoencoder.fit(X_scaled, X_scaled, epochs=20, batch_size=32, verbose=0)
                    encoder = Model(input_layer, encoded)
                    factor_series = pd.Series(encoder.predict(X_scaled)[:,0], index=X.index)
                    factor_name = "AutoEncoder_ì„ë² ë”©"
                else:
                    st.warning("ì•„ì§ ìë™í™”ëœ ML/DL íŒ©í„° ìƒì„± ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.")
                    st.stop()
                # ë©€í‹° ì¸ë±ìŠ¤ ë³´ì¥
                multi_index_df = financial_data.reset_index().set_index(['Date', 'Stock'])
                factor_series = pd.Series(factor_series.values, index=multi_index_df.index, name=factor_name)
                factor_series = factor_series.fillna(method='ffill').fillna(method='bfill')
                simulated_ic = np.random.uniform(0.01, 0.10)
                simulated_icir = simulated_ic / np.random.uniform(0.01, 0.05)
                if 'factor_zoo' not in st.session_state:
                    st.session_state.factor_zoo = {}
                st.session_state.factor_zoo[factor_name] = {
                    'data': factor_series,
                    'ic': simulated_ic,
                    'icir': simulated_icir,
                    'expression': selected_ml
                }
                st.success(f"íŒ©í„° '{factor_name}' ìƒì„± ì™„ë£Œ!")
            except Exception as e:
                st.error(f"ML/DL íŒ©í„° ìƒì„± ì˜¤ë¥˜: {e}")

# --- íŒ©í„° ë™ë¬¼ì› í˜„í™© ---
if 'factor_zoo' in st.session_state and st.session_state.factor_zoo:
    st.markdown("---")
    st.subheader("íŒ©í„° ë™ë¬¼ì› (Factor Zoo) í˜„í™© ğŸ’")
    zoo_data = [
        {
            'íŒ©í„°ëª…': name,
            'IC': info['ic'],
            'ICIR': info['icir'],
            'ìˆ˜ì‹/ë°©ë²•': info['expression']
        }
        for name, info in st.session_state.factor_zoo.items()
    ]
    st.dataframe(pd.DataFrame(zoo_data).sort_values(by='IC', ascending=False), use_container_width=True)

